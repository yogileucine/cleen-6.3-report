{"uid":"f1b3b7b8b8bfaa81","name":"Validate master data snapshot report for production and equipment mapping","fullName":"tests.scenarios.audit_portal.test_audit_portal_formulation_facility.TestAuditPortalLimits#test_validate_master_data_snapshot_report_production_equipment_mapping","historyId":"a92a9d40706c70f20be0dc8e7b406b7f","time":{"start":1734427435620,"stop":1734427435930,"duration":310},"description":"This test case test API to validate the master data snapshot report for productions and equipment mapping with excel file data","descriptionHtml":"<p>This test case test API to validate the master data snapshot report for productions and equipment mapping with excel file data</p>\n","status":"failed","statusMessage":"AssertionError: Mismatch in column 'Constituent Equipment' at index (2) Vibratory Sifter - 1 (ID: EQM-2), Vibratory Sifter - 2 (ID: EQM-3) Not Equal Vibratory Sifter - 2 (ID: EQM-3), Vibratory Sifter - 1 (ID: EQM-2)","statusTrace":"self = <test_audit_portal_formulation_facility.TestAuditPortalLimits object at 0x7a81123fce30>\n\n    @allure.title(\"Validate master data snapshot report for production and equipment mapping\")\n    @allure.description(\"This test case test API to validate the master data snapshot report for productions and \"\n                        \"equipment mapping with excel file data\")\n    @allure.link(\"https://app.clickup.com/t/85zt9qzh3\")\n    @pytest.mark.validate_master_data_snapshot_report_production_equipment_mapping\n    def test_validate_master_data_snapshot_report_production_equipment_mapping(self):\n        data = {}\n        mismatched_rows = []\n        assert_flag = False\n    \n        data.update({\"sheet_name\": \"ProductionEquipmentMatrix\"})\n    \n        master_data_snapshot = self.get_audit_portal.test_config_new_master_data_snapshot_report(data)[\"response\"]\n    \n        if master_data_snapshot:\n            master_data_snapshot = pd.json_normalize(master_data_snapshot)\n    \n            columns_mapping = {\"production\": \"Production\", \"equipmentEntity\": \"Equipment Entity\",\n                               \"type\": \"Type\", \"constituentEquipment\": \"Constituent Equipment\"}\n    \n            excel_data = pd.read_excel(const.get_master_data(), sheet_name=\"prod-eq-mapping\", usecols='A:D', nrows=23)\n            allure.attach(excel_data.to_html(), name=\"excel_data\", attachment_type=allure.attachment_type.HTML)\n    \n            api_df = master_data_snapshot[columns_mapping.keys()]\n            excel_df = excel_data[columns_mapping.values()]\n            allure.attach(api_df.to_html(), name=\"api_df\", attachment_type=allure.attachment_type.HTML)\n            allure.attach(excel_df.to_html(), name=\"excel_df\", attachment_type=allure.attachment_type.HTML)\n    \n            api_df_sorted = api_df.sort_values(by=list(columns_mapping.keys())).reset_index(drop=True)\n            excel_df_sorted = excel_df.sort_values(by=list(columns_mapping.values())).reset_index(drop=True)\n    \n            allure.attach(excel_df_sorted.to_html(), name=\"excel_df_sort\", attachment_type=allure.attachment_type.HTML)\n            allure.attach(api_df_sorted.to_html(), name=\"api_sort\", attachment_type=allure.attachment_type.HTML)\n    \n            api_df_sorted = api_df_sorted.rename(columns=columns_mapping)\n    \n            max_rows = max(len(api_df_sorted), len(excel_df_sorted))\n    \n            numeric_columns = api_df_sorted.select_dtypes(include=np.number).columns\n            string_columns = api_df_sorted.select_dtypes(include=object).columns\n    \n            for row in range(max_rows):\n                if row >= len(excel_df_sorted):\n                    mismatched_rows.append(row)\n                    continue\n                comparison_successful = True\n                for column in string_columns:\n                    api_value = api_df_sorted.loc[row, column]\n                    excel_value = excel_df_sorted.loc[row, column]\n    \n                    if api_value == \"-\" and math.isnan(excel_value):\n                        continue\n    \n>                   comparison_successful &= compare_portal(api_value, excel_value, column, row)\n\ntests/scenarios/audit_portal/test_audit_portal_formulation_facility.py:708: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresponse_value = 'Vibratory Sifter - 1 (ID: EQM-2), Vibratory Sifter - 2 (ID: EQM-3)', excel_value = 'Vibratory Sifter - 2 (ID: EQM-3), Vibratory Sifter - 1 (ID: EQM-2)', column = 'Constituent Equipment'\nrow = 2\n\n    def compare_portal(response_value, excel_value, column, row):\n        error_message = f\"Mismatch in column '{column}' at index ({row})\"\n    \n        if response_value == \"-\" and math.isnan(excel_value):\n            return True\n    \n        if str(response_value) != \"#N/A\" and str(excel_value) != \"#N/A\":\n            if isinstance(response_value, (int, float)) and isinstance(excel_value, (int, float)):\n                if math.isnan(response_value) or math.isnan(excel_value):\n                    return True\n                if response_value < 1:\n                    length = (floor(log10(response_value)) - 1)\n                else:\n                    length = 15 - len(str(int(response_value)))\n                if length < 0:\n                    response_value = (round(response_value, -length + 3))\n                    excel_value = (round(excel_value, -length + 1))\n                    assert response_value == excel_value, error_message + \" \" + str(\n                        response_value) + \" Not Equal \" + str(excel_value)\n                else:\n                    response_value = round(response_value, 3)\n                    excel_value = round(excel_value, 3)\n                    assert response_value == excel_value, error_message + \" \" + str(\n                        response_value) + \" Not Equal \" + str(excel_value)\n            else:\n>               assert str(response_value).lower() == str(excel_value).lower(), error_message + \" \" + str(\n                    response_value) + \" Not Equal \" + str(excel_value)\nE               AssertionError: Mismatch in column 'Constituent Equipment' at index (2) Vibratory Sifter - 1 (ID: EQM-2), Vibratory Sifter - 2 (ID: EQM-3) Not Equal Vibratory Sifter - 2 (ID: EQM-3), Vibratory Sifter - 1 (ID: EQM-2)\n\nutil/common_methods.py:105: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"login","time":{"start":1734427407453,"stop":1734427407785,"duration":332},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"get_facility","time":{"start":1734427407786,"stop":1734427407992,"duration":206},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"testStage":{"description":"This test case test API to validate the master data snapshot report for productions and equipment mapping with excel file data","status":"failed","statusMessage":"AssertionError: Mismatch in column 'Constituent Equipment' at index (2) Vibratory Sifter - 1 (ID: EQM-2), Vibratory Sifter - 2 (ID: EQM-3) Not Equal Vibratory Sifter - 2 (ID: EQM-3), Vibratory Sifter - 1 (ID: EQM-2)","statusTrace":"self = <test_audit_portal_formulation_facility.TestAuditPortalLimits object at 0x7a81123fce30>\n\n    @allure.title(\"Validate master data snapshot report for production and equipment mapping\")\n    @allure.description(\"This test case test API to validate the master data snapshot report for productions and \"\n                        \"equipment mapping with excel file data\")\n    @allure.link(\"https://app.clickup.com/t/85zt9qzh3\")\n    @pytest.mark.validate_master_data_snapshot_report_production_equipment_mapping\n    def test_validate_master_data_snapshot_report_production_equipment_mapping(self):\n        data = {}\n        mismatched_rows = []\n        assert_flag = False\n    \n        data.update({\"sheet_name\": \"ProductionEquipmentMatrix\"})\n    \n        master_data_snapshot = self.get_audit_portal.test_config_new_master_data_snapshot_report(data)[\"response\"]\n    \n        if master_data_snapshot:\n            master_data_snapshot = pd.json_normalize(master_data_snapshot)\n    \n            columns_mapping = {\"production\": \"Production\", \"equipmentEntity\": \"Equipment Entity\",\n                               \"type\": \"Type\", \"constituentEquipment\": \"Constituent Equipment\"}\n    \n            excel_data = pd.read_excel(const.get_master_data(), sheet_name=\"prod-eq-mapping\", usecols='A:D', nrows=23)\n            allure.attach(excel_data.to_html(), name=\"excel_data\", attachment_type=allure.attachment_type.HTML)\n    \n            api_df = master_data_snapshot[columns_mapping.keys()]\n            excel_df = excel_data[columns_mapping.values()]\n            allure.attach(api_df.to_html(), name=\"api_df\", attachment_type=allure.attachment_type.HTML)\n            allure.attach(excel_df.to_html(), name=\"excel_df\", attachment_type=allure.attachment_type.HTML)\n    \n            api_df_sorted = api_df.sort_values(by=list(columns_mapping.keys())).reset_index(drop=True)\n            excel_df_sorted = excel_df.sort_values(by=list(columns_mapping.values())).reset_index(drop=True)\n    \n            allure.attach(excel_df_sorted.to_html(), name=\"excel_df_sort\", attachment_type=allure.attachment_type.HTML)\n            allure.attach(api_df_sorted.to_html(), name=\"api_sort\", attachment_type=allure.attachment_type.HTML)\n    \n            api_df_sorted = api_df_sorted.rename(columns=columns_mapping)\n    \n            max_rows = max(len(api_df_sorted), len(excel_df_sorted))\n    \n            numeric_columns = api_df_sorted.select_dtypes(include=np.number).columns\n            string_columns = api_df_sorted.select_dtypes(include=object).columns\n    \n            for row in range(max_rows):\n                if row >= len(excel_df_sorted):\n                    mismatched_rows.append(row)\n                    continue\n                comparison_successful = True\n                for column in string_columns:\n                    api_value = api_df_sorted.loc[row, column]\n                    excel_value = excel_df_sorted.loc[row, column]\n    \n                    if api_value == \"-\" and math.isnan(excel_value):\n                        continue\n    \n>                   comparison_successful &= compare_portal(api_value, excel_value, column, row)\n\ntests/scenarios/audit_portal/test_audit_portal_formulation_facility.py:708: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresponse_value = 'Vibratory Sifter - 1 (ID: EQM-2), Vibratory Sifter - 2 (ID: EQM-3)', excel_value = 'Vibratory Sifter - 2 (ID: EQM-3), Vibratory Sifter - 1 (ID: EQM-2)', column = 'Constituent Equipment'\nrow = 2\n\n    def compare_portal(response_value, excel_value, column, row):\n        error_message = f\"Mismatch in column '{column}' at index ({row})\"\n    \n        if response_value == \"-\" and math.isnan(excel_value):\n            return True\n    \n        if str(response_value) != \"#N/A\" and str(excel_value) != \"#N/A\":\n            if isinstance(response_value, (int, float)) and isinstance(excel_value, (int, float)):\n                if math.isnan(response_value) or math.isnan(excel_value):\n                    return True\n                if response_value < 1:\n                    length = (floor(log10(response_value)) - 1)\n                else:\n                    length = 15 - len(str(int(response_value)))\n                if length < 0:\n                    response_value = (round(response_value, -length + 3))\n                    excel_value = (round(excel_value, -length + 1))\n                    assert response_value == excel_value, error_message + \" \" + str(\n                        response_value) + \" Not Equal \" + str(excel_value)\n                else:\n                    response_value = round(response_value, 3)\n                    excel_value = round(excel_value, 3)\n                    assert response_value == excel_value, error_message + \" \" + str(\n                        response_value) + \" Not Equal \" + str(excel_value)\n            else:\n>               assert str(response_value).lower() == str(excel_value).lower(), error_message + \" \" + str(\n                    response_value) + \" Not Equal \" + str(excel_value)\nE               AssertionError: Mismatch in column 'Constituent Equipment' at index (2) Vibratory Sifter - 1 (ID: EQM-2), Vibratory Sifter - 2 (ID: EQM-3) Not Equal Vibratory Sifter - 2 (ID: EQM-3), Vibratory Sifter - 1 (ID: EQM-2)\n\nutil/common_methods.py:105: AssertionError","steps":[],"attachments":[{"uid":"e81d69c47e1a1c8f","name":"excel_data","source":"e81d69c47e1a1c8f.html","type":"text/html","size":4767},{"uid":"ce3e2581b503dc61","name":"api_df","source":"ce3e2581b503dc61.html","type":"text/html","size":4723},{"uid":"35f2b2721224cf1e","name":"excel_df","source":"35f2b2721224cf1e.html","type":"text/html","size":4767},{"uid":"75c61858b3591b11","name":"excel_df_sort","source":"75c61858b3591b11.html","type":"text/html","size":4767},{"uid":"e9dbe52ba3f77ea5","name":"api_sort","source":"e9dbe52ba3f77ea5.html","type":"text/html","size":4723}],"parameters":[],"shouldDisplayMessage":true,"stepsCount":0,"attachmentsCount":5,"hasContent":true,"attachmentStep":false},"afterStages":[],"labels":[{"name":"tag","value":"validate_master_data_snapshot_report_production_equipment_mapping"},{"name":"tag","value":"run(order=1)"},{"name":"tag","value":"second"},{"name":"tag","value":"formulation"},{"name":"tag","value":"audit_portal_limits"},{"name":"tag","value":"scenario"},{"name":"parentSuite","value":"tests.scenarios.audit_portal"},{"name":"suite","value":"test_audit_portal_formulation_facility"},{"name":"subSuite","value":"TestAuditPortalLimits"},{"name":"host","value":"ubuntu"},{"name":"thread","value":"1861087-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.scenarios.audit_portal.test_audit_portal_formulation_facility"},{"name":"resultFormat","value":"allure2"}],"parameters":[],"links":[{"name":"https://app.clickup.com/t/85zt9qzh3","url":"https://app.clickup.com/t/85zt9qzh3","type":"link"}],"hidden":true,"retry":true,"extra":{"categories":[],"tags":["validate_master_data_snapshot_report_production_equipment_mapping","scenario","run(order=1)","formulation","audit_portal_limits","second"]},"source":"f1b3b7b8b8bfaa81.json","parameterValues":[]}